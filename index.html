<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧型 JSON/XML/CSV/Excel 報表產生器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .hidden { display: none !important; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6; color: #333; max-width: 1200px;
            margin: 20px auto; padding: 0 20px; background-color: #f4f7f6;
        }

        /* 主標題和語言切換按鈕的容器 */
        .header-container {
            position: relative;
            text-align: center;
            margin-bottom: 30px;
        }
        h1 { color: #2c3e50; margin: 0; }
        #lang-toggle-btn {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            padding: 5px 12px;
            font-size: 0.9em;
            background-color: #7f8c8d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #lang-toggle-btn:hover { background-color: #95a5a6; }
        
        h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; text-align: center; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 20px; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #drop-area { border: 2px dashed #bdc3c7; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; background-color: #fff; transition: background-color 0.3s, border-color 0.3s; margin-bottom: 20px; }
        #drop-area.highlight { border-color: #3498db; background-color: #ecf5ff; }
        #file-input { display: none; }
        .content-box { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #post-load-controls { text-align: center; }
        #generate-btn { padding: 12px 25px; font-size: 1.1em; color: #fff; background-color: #3498db; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; margin-top: 10px; }
        
        /* 修改此處：調整 table-actions-container 的佈局以容納多個匯出按鈕 */
        .table-actions-container {
            display: flex;
            flex-direction: column; /* 讓內容垂直排列 */
            gap: 15px; /* 按鈕間距 */
            margin-top: 20px;
            margin-bottom: 20px;
            align-items: center; /* 水平居中 */
        }

        .table-search-controls {
            display: flex;
            gap: 10px;
            width: 100%; /* 佔滿可用寬度 */
            max-width: 600px; /* 限制最大寬度，避免過寬 */
        }
        #search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #search-btn {
            padding: 10px 20px; font-size: 1em; color: #fff; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;
            background-color: #3498db;
        }

        /* 匯出按鈕群組 */
        .export-buttons-group {
            display: flex;
            flex-wrap: wrap; /* 允許換行 */
            gap: 10px; /* 按鈕間距 */
            justify-content: center; /* 居中對齊 */
            width: 100%;
        }

        /* 統一匯出按鈕樣式 */
        .export-buttons-group button {
            padding: 10px 20px;
            font-size: 1em;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            flex-grow: 1; /* 讓按鈕在空間允許下等寬延伸 */
            max-width: 180px; /* 限制單個按鈕最大寬度 */
            transition: background-color 0.3s;
        }

        #export-excel-btn { background-color: #27ae60; } /* Excel 綠色 */
        #export-csv-btn { background-color: #f39c12; } /* CSV 橘色 */
        #export-json-btn { background-color: #e74c3c; } /* JSON 紅色 */
        #export-xml-btn { background-color: #9b59b6; } /* XML 紫色 */

        .export-buttons-group button:disabled { background-color: #95a5a6; cursor: not-allowed; }

        #filter-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .filter-control label { margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #34495e; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-control select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bdc3c7; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; overflow-wrap: break-word; word-break: break-word; }
        th.sortable { cursor: pointer; } th.sortable:hover { background-color: #e9e9e9; }
        th.sortable::after { content: ''; display: inline-block; width: 1em; text-align: center; margin-left: 5px; opacity: 0.5; }
        th.sort-asc::after { content: '▲'; opacity: 1; } th.sort-desc::after { content: '▼'; opacity: 1; }
    </style>
</head>
<body>
    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p data-lang-key="loaderText">資料處理中，請稍候...</p>
    </div>

    <div class="header-container">
        <h1 data-lang-key="pageTitle">智慧型 JSON/XML/CSV/Excel 報表產生器</h1>
        <button id="lang-toggle-btn">English</button>
    </div>
    
    <div id="drop-area">
        <input type="file" id="file-input" accept=".json, .xml, .csv, .xls, .xlsx">
        <p data-lang-key="dropAreaPrompt">拖曳 JSON、XML、CSV 或 Excel (.xls, .xlsx) 檔案到這裡，或點擊選擇檔案</p>
    </div>
    
    <div id="post-load-controls" class="content-box hidden">
        <p id="file-status"></p>
        <button id="generate-btn" data-lang-key="generateBtn">生成報表與篩選器</button>
    </div>

    <div id="main-content" class="hidden">
        <div class="content-box">
            <h2 data-lang-key="filterTitle">欄位篩選器</h2>
            <div id="filter-container"></div>
        </div>
        <div class="content-box">
            <h2 data-lang-key="tableTitle">資料表格</h2>
            <div class="table-actions-container">
                <div class="table-search-controls">
                    <input type="text" id="search-input" data-lang-key="searchInputPlaceholder">
                    <button id="search-btn" data-lang-key="searchBtn">送出查詢</button>
                </div>
                <div class="export-buttons-group">
                    <button id="export-excel-btn" disabled data-lang-key="exportExcelBtn">匯出為 Excel</button>
                    <button id="export-csv-btn" disabled data-lang-key="exportCsvBtn">匯出為 CSV</button>
                    <button id="export-json-btn" disabled data-lang-key="exportJsonBtn">匯出為 JSON</button>
                    <button id="export-xml-btn" disabled data-lang-key="exportXmlBtn">匯出為 XML</button>
                </div>
            </div>
            <div id="table-container"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const translations = {
                'zh': {
                    pageTitle: '智慧型 JSON/XML/CSV/Excel 報表產生器',
                    toggleLangBtn: 'English',
                    // 【修改 2】: 更新中文提示文字
                    dropAreaPrompt: '拖曳 JSON、XML、CSV 或 Excel (.xls, .xlsx) 檔案到這裡，或點擊選擇檔案',
                    generateBtn: '生成報表與篩選器',
                    filterTitle: '欄位篩選器',
                    tableTitle: '資料表格',
                    searchInputPlaceholder: '對篩選後的結果進行關鍵字查詢...',
                    searchBtn: '送出查詢',
                    exportExcelBtn: '匯出為 Excel',
                    exportCsvBtn: '匯出為 CSV',
                    exportJsonBtn: '匯出為 JSON',
                    exportXmlBtn: '匯出為 XML',
                    loaderText: '資料處理中，請稍候...',
                    allOption: '-- 全部 --',
                    noData: '沒有符合條件的資料。',
                    // 【修改 3】: 更新中文錯誤訊息
                    fileTypeError: '錯誤：請上傳 JSON、XML、CSV 或 Excel (.xls, .xlsx) 格式的檔案！',
                    largeFileConfirm: (size) => `您選擇的檔案大小為 ${size} MB，載入與處理可能需要較長時間。\n\n確定要繼續嗎？`,
                    fileParseError: (msg) => `檔案處理失敗：\n${msg}`,
                    fileReadError: '讀取檔案時發生錯誤！',
                    buildError: (msg) => `生成報表時發生錯誤：\n${msg}`,
                    fileLoaded: (name, count) => `檔案 "${name}" 已成功載入 (${count} 筆資料)。`
                },
                'en': {
                    pageTitle: 'Intelligent JSON/XML/CSV/Excel Report Generator',
                    toggleLangBtn: '中文',
                    // 【修改 4】: 更新英文提示文字
                    dropAreaPrompt: 'Drag & drop a JSON, XML, CSV, or Excel (.xls, .xlsx) file here, or click to select',
                    generateBtn: 'Generate Report & Filters',
                    filterTitle: 'Column Filters',
                    tableTitle: 'Data Table',
                    searchInputPlaceholder: 'Search keyword in filtered results...',
                    searchBtn: 'Search',
                    exportExcelBtn: 'Export to Excel',
                    exportCsvBtn: 'Export to CSV',
                    exportJsonBtn: 'Export to JSON',
                    exportXmlBtn: 'Export to XML',
                    loaderText: 'Processing data, please wait...',
                    allOption: '-- All --',
                    noData: 'No data matches the criteria.',
                    // 【修改 5】: 更新英文錯誤訊息
                    fileTypeError: 'Error: Please upload a JSON, XML, CSV, or Excel (.xls, .xlsx) file!',
                    largeFileConfirm: (size) => `The selected file is ${size} MB, which may take a long time to load and process.\n\nAre you sure you want to continue?`,
                    fileParseError: (msg) => `File processing failed:\n${msg}`,
                    fileReadError: 'An error occurred while reading the file!',
                    buildError: (msg) => `An error occurred while building the report:\n${msg}`,
                    fileLoaded: (name, count) => `File "${name}" loaded successfully (${count} records).`
                }
            };
            let currentLang = 'zh';

            const langToggleBtn = document.getElementById('lang-toggle-btn');
            const allLangElements = document.querySelectorAll('[data-lang-key]');
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const loader = document.getElementById('loader');
            const postLoadControls = document.getElementById('post-load-controls');
            const fileStatus = document.getElementById('file-status');
            const generateBtn = document.getElementById('generate-btn');
            const mainContent = document.getElementById('main-content');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            // 獲取所有匯出按鈕的 DOM 元素
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportJsonBtn = document.getElementById('export-json-btn');
            const exportXmlBtn = document.getElementById('export-xml-btn');

            const filterContainer = document.getElementById('filter-container');
            const tableContainer = document.getElementById('table-container');

            let originalData = [], currentViewData = [], headers = [], sortState = { column: null, direction: 'none' };
            const LARGE_FILE_THRESHOLD = 1 * 1024 * 1024; // 1 MB

            function setLanguage(lang) {
                if (!translations[lang]) return;
                currentLang = lang;
                const dict = translations[lang];

                document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : 'en';
                document.title = dict.pageTitle;
                
                allLangElements.forEach(el => {
                    const key = el.getAttribute('data-lang-key');
                    if (dict[key]) {
                        if (el.tagName === 'INPUT' && el.placeholder !== undefined) {
                            el.placeholder = dict[key];
                        } else {
                            el.textContent = dict[key];
                        }
                    }
                });
                langToggleBtn.textContent = dict.toggleLangBtn;
                // 需要重新渲染下拉選單和表格中的文字
                if (originalData.length > 0) {
                    renderFilters();
                    renderTable();
                }
            }
            
            langToggleBtn.addEventListener('click', () => {
                const newLang = currentLang === 'zh' ? 'en' : 'zh';
                setLanguage(newLang);
            });

            dropArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            dropArea.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, p => { p.preventDefault(); p.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(e => dropArea.addEventListener(e, () => dropArea.classList.add('highlight')));
            ['dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, () => dropArea.classList.remove('highlight')));
            generateBtn.addEventListener('click', buildUI);
            
            // 為新的匯出按鈕添加事件監聽器
            exportExcelBtn.addEventListener('click', exportToExcel);
            exportCsvBtn.addEventListener('click', exportToCsv);
            exportJsonBtn.addEventListener('click', exportToJson);
            exportXmlBtn.addEventListener('click', exportToXml);

            searchBtn.addEventListener('click', updateView);
            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    updateView();
                }
            });

            function parseXmlToObjects(xmlString) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                if (xmlDoc.getElementsByTagName("parsererror").length) {
                    throw new Error("XML 檔案格式錯誤，無法解析。");
                }

                const allTags = xmlDoc.getElementsByTagName('*');
                const tagCounts = {};
                for (let i = 0; i < allTags.length; i++) {
                    const tagName = allTags[i].tagName;
                    tagCounts[tagName] = (tagCounts[tagName] || 0) + 1;
                }

                let recordTagName = '';
                let maxCount = 0;
                for (const tagName in tagCounts) {
                    if (tagCounts[tagName] > 1 && tagCounts[tagName] > maxCount) {
                        maxCount = tagCounts[tagName];
                        recordTagName = tagName;
                    }
                }

                if (!recordTagName) {
                    const rootChildren = xmlDoc.documentElement.children;
                    if (rootChildren.length > 0) {
                        recordTagName = rootChildren[0].tagName;
                    } else {
                        throw new Error("XML 檔案中找不到任何資料紀錄。");
                    }
                }

                const records = xmlDoc.getElementsByTagName(recordTagName);
                if (records.length === 0) {
                    throw new Error("無法根據自動偵測找到有效的資料列。");
                }

                const dataArray = Array.from(records).map(recordNode => {
                    const obj = {};
                    const fields = Array.from(recordNode.children);
                    fields.forEach(fieldNode => {
                        obj[fieldNode.tagName] = fieldNode.textContent.trim();
                    });
                    return obj;
                }).filter(obj => Object.keys(obj).length > 0);

                if (dataArray.length === 0) {
                    throw new Error("無法從 XML 檔案中提取任何有效的資料。");
                }
                return dataArray;
            }

            function parseCsvToObjects(csvString) {
                const lines = csvString.trim().split(/\r\n|\n/);
                if (lines.length === 0) {
                    throw new Error("CSV 檔案內容為空。");
                }

                const parseLine = (line) => {
                    const result = [];
                    let inQuote = false;
                    let currentField = '';
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            if (inQuote && i + 1 < line.length && line[i+1] === '"') {
                                currentField += '"';
                                i++; 
                            } else {
                                inQuote = !inQuote;
                            }
                        } else if (char === ',' && !inQuote) {
                            result.push(currentField.trim());
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    result.push(currentField.trim());
                    return result;
                };

                const headers = parseLine(lines[0]);
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    const values = parseLine(lines[i]);
                    if (values.length !== headers.length) {
                        console.warn(`警告：第 ${i + 1} 行的欄位數與標頭不符，已跳過。`);
                        continue;
                    }
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    data.push(obj);
                }
                if (data.length === 0) {
                    throw new Error("無法從 CSV 檔案中提取任何有效的資料。請檢查檔案格式。");
                }
                return data;
            }

            // 【新增函式】: 解析 Excel (XLS/XLSX) 檔案
            function parseExcelToObjects(arrayBuffer) {
                // 1. 使用 XLSX 函式庫讀取 ArrayBuffer
                const data = new Uint8Array(arrayBuffer);
                const wb = XLSX.read(data, { type: 'array' });

                // 2. 獲取第一個工作表 (Sheet)
                const sheetName = wb.SheetNames[0];
                if (!sheetName) {
                    throw new Error("Excel 檔案中找不到任何工作表。");
                }
                const ws = wb.Sheets[sheetName];

                // 3. 將工作表轉換為「陣列的陣列」格式 (header: 1)
                // 這樣我們才能手動尋找標題列
                const dataRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });

                if (dataRows.length === 0) {
                    throw new Error("工作表內容為空。");
                }

                let headerRowIndex = -1;
                let headers = [];

                // 4. 【核心邏輯】: 尋找標題列
                // 遍歷每一列，找到第一個「所有儲存格都有值」的列
                for (let i = 0; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    if (!row || row.length === 0) continue; // 略過空行

                    // 檢查此列是否所有儲存格都有值 (不為 null, undefined 或空字串)
                    const allFilled = row.every(cell => cell !== null && cell !== undefined && String(cell).trim() !== '');
                    
                    if (allFilled) {
                        headerRowIndex = i; // 找到了！
                        headers = row.map(cell => String(cell).trim()); // 儲存標題
                        break; // 停止尋找
                    }
                }

                if (headerRowIndex === -1) {
                    throw new Error("無法在檔案中找到符合 '所有欄位都有值' 條件的標題列。");
                }

                // 5. 根據找到的標題列，建立 JSON 物件陣列
                const jsonData = [];
                for (let i = headerRowIndex + 1; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    if (!row) continue; // 略過空行

                    const obj = {};
                    let hasData = false; // 檢查此行是否為空資料行
                    for (let j = 0; j < headers.length; j++) {
                        const value = row[j];
                        obj[headers[j]] = value;
                        if (value !== null && value !== undefined) {
                            hasData = true;
                        }
                    }

                    // 只有在該行至少有一個欄位有資料時才加入
                    if (hasData) {
                        jsonData.push(obj);
                    }
                }
                
                if (jsonData.length === 0) {
                     throw new Error("找到了標題列，但標題列下沒有任何可讀取的資料。");
                }
                
                return jsonData;
            }

            function handleFile(file) {
                if (!file) return;
                const dict = translations[currentLang];
                const fileName = file.name.toLowerCase();

                const isJson = fileName.endsWith('.json');
                const isXml = fileName.endsWith('.xml');
                const isCsv = fileName.endsWith('.csv');
                // 【修改 6】: 增加 Excel 檔案判斷
                const isExcel = fileName.endsWith('.xls') || fileName.endsWith('.xlsx');

                // 【修改 7】: 更新檔案類型驗證
                if (!isJson && !isXml && !isCsv && !isExcel) {
                    alert(dict.fileTypeError);
                    fileInput.value = '';
                    return;
                }

                if (file.size > LARGE_FILE_THRESHOLD) {
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                    if (!confirm(dict.largeFileConfirm(fileSizeMB))) {
                        fileInput.value = '';
                        return;
                    }
                }

                showLoader(true);
                const reader = new FileReader();
                reader.onload = (event) => {
                    setTimeout(() => {
                        try {
                            let data;
                            // 【修改 8】: 增加 Excel 的解析分支
                            if (isJson) {
                                data = JSON.parse(event.target.result);
                            } else if (isXml) {
                                data = parseXmlToObjects(event.target.result);
                            } else if (isCsv) {
                                data = parseCsvToObjects(event.target.result);
                            } else if (isExcel) {
                                // Excel 傳入的是 event.target.result (ArrayBuffer)
                                data = parseExcelToObjects(event.target.result);
                            }
                            
                            if (!Array.isArray(data) || data.length === 0) throw new Error('檔案內容無法轉換為有效的資料列表。');
                            prepareForGeneration(data, file.name);
                        } catch (e) {
                            alert(dict.fileParseError(e.message));
                        } finally {
                            showLoader(false);
                        }
                    }, 10);
                };
                reader.onerror = () => { showLoader(false); alert(dict.fileReadError); };
                
                // 【修改 9】: 根據檔案類型決定讀取方式
                if (isExcel) {
                    reader.readAsArrayBuffer(file); // Excel 讀取為 ArrayBuffer
                } else {
                    reader.readAsText(file, 'UTF-8'); // 其他檔案 (JSON, XML, CSV) 讀取為 Text
                }
            }

            function prepareForGeneration(data, fileName) {
                originalData = data;
                mainContent.classList.add('hidden');
                postLoadControls.classList.remove('hidden');
                fileStatus.textContent = translations[currentLang].fileLoaded(fileName, originalData.length);
                generateBtn.disabled = false;
            }

            function buildUI() {
                showLoader(true);
                setTimeout(() => {
                    try {
                        if (originalData.length === 0) {
                            throw new Error("無法從檔案中提取資料，請檢查檔案內容。");
                        }
                        headers = Object.keys(originalData[0]);
                        sortState = { column: null, direction: 'none' };
                        searchInput.value = '';
                        renderFilters();
                        updateView();
                        mainContent.classList.remove('hidden');
                        postLoadControls.classList.add('hidden');
                    } catch (e) {
                        alert(translations[currentLang].buildError(e.message));
                    } finally {
                        showLoader(false);
                    }
                }, 10);
            }

            function renderFilters() {
                filterContainer.innerHTML = '';
                const allOptionText = translations[currentLang].allOption;
                headers.forEach(header => {
                    const uniqueValues = [...new Set(originalData.map(item => item[header]))].filter(v => v != null).sort((a, b) => String(a).localeCompare(String(b), 'zh-Hant'));
                    const control = document.createElement('div');
                    control.className = 'filter-control';
                    control.innerHTML = `<label for="filter-${header}" title="${header}">${header}</label>
                        <select id="filter-${header}" data-column="${header}"><option value="">${allOptionText}</option>
                        ${uniqueValues.map(value => `<option value="${escapeHtml(value)}">${escapeHtml(value)}</option>`).join('')}</select>`;
                    control.querySelector('select').addEventListener('change', updateView);
                    filterContainer.appendChild(control);
                });
            }

            function renderTable() {
                tableContainer.innerHTML = '';
                // 統一控制所有匯出按鈕的禁用狀態
                const isDisabled = currentViewData.length === 0;
                exportExcelBtn.disabled = isDisabled;
                exportCsvBtn.disabled = isDisabled;
                exportJsonBtn.disabled = isDisabled;
                exportXmlBtn.disabled = isDisabled;

                if (isDisabled) {
                    tableContainer.innerHTML = `<p style="text-align:center; color:#999; font-style:italic;">${translations[currentLang].noData}</p>`;
                    return;
                }
                const table = document.createElement('table');
                table.createTHead().insertRow();
                table.createTBody();
                const headerRow = table.tHead.rows[0];
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.className = 'sortable';
                    th.textContent = header;
                    if (sortState.column === header) th.classList.add(`sort-${sortState.direction}`);
                    th.addEventListener('click', () => handleSort(header));
                    headerRow.appendChild(th);
                });
                currentViewData.forEach(rowObject => {
                    const row = table.tBodies[0].insertRow();
                    headers.forEach(header => {
                        const cell = row.insertCell();
                        cell.textContent = rowObject[header] ?? "";
                    });
                });
                tableContainer.appendChild(table);
            }

            function showLoader(show) {
                show ? loader.classList.remove('hidden') : loader.classList.add('hidden');
            }

            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return unsafe;
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            function updateView() {
                let filteredData = [...originalData];
                filterContainer.querySelectorAll('select').forEach(select => {
                    if (select.value !== "") {
                        const column = select.dataset.column;
                        const value = select.value;
                        filteredData = filteredData.filter(row => String(row[column]) === value);
                    }
                });
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (searchTerm) {
                    filteredData = filteredData.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(searchTerm)));
                }
                currentViewData = filteredData;
                applySort();
                renderTable();
            }

            function handleSort(column) {
                const currentDirection = sortState.column === column ? sortState.direction : 'none';
                sortState = { column, direction: currentDirection === 'asc' ? 'desc' : 'asc' };
                applySort();
                renderTable();
            }

            function applySort() {
                const { column, direction } = sortState;
                if (!column) return;
                currentViewData.sort((a, b) => {
                    const valA = a[column];
                    const valB = b[column];

                    if (valA == null) return 1;
                    if (valB == null) return -1;

                    const comparison = typeof valA === 'number' && typeof valB === 'number' ? valA - valB : String(valA).localeCompare(String(valB), 'zh-Hant');
                    return direction === 'asc' ? comparison : -comparison;
                });
            }

            // 匯出為 Excel
            function exportToExcel() {
                if (currentViewData.length === 0) return;
                const ws = XLSX.utils.json_to_sheet(currentViewData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "篩選結果");
                XLSX.writeFile(wb, `report_${new Date().toISOString().slice(0,10)}.xlsx`);
            }

            // 匯出為 CSV
            function exportToCsv() {
                if (currentViewData.length === 0 || headers.length === 0) return;

                // 處理特殊字元，例如逗號和引號
                const escapeCsvField = (field) => {
                    if (field == null) return '';
                    let value = String(field);
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                };

                const csvRows = [];
                // 添加標頭
                csvRows.push(headers.map(escapeCsvField).join(','));

                // 添加資料行
                currentViewData.forEach(row => {
                    const values = headers.map(header => escapeCsvField(row[header]));
                    csvRows.push(values.join(','));
                });

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // 匯出為 JSON
            function exportToJson() {
                if (currentViewData.length === 0) return;
                const jsonString = JSON.stringify(currentViewData, null, 2); // null, 2 for pretty print
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // 匯出為 XML
            function exportToXml() {
                if (currentViewData.length === 0 || headers.length === 0) return;

                const escapeXmlField = (field) => {
                    if (field == null) return '';
                    let value = String(field);
                    return value
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&apos;");
                };

                let xmlString = '<?xml version="1.0" encoding="UTF-8"?>\n<data>\n';
                currentViewData.forEach((rowObject, index) => {
                    xmlString += `  <record id="${index + 1}">\n`;
                    headers.forEach(header => {
                        const tagName = header.replace(/[^a-zA-Z0-9_]/g, '_'); // 轉換非法 XML 標籤字元
                        xmlString += `    <${tagName}>${escapeXmlField(rowObject[header])}</${tagName}>\n`;
                    });
                    xmlString += `  </record>\n`;
                });
                xmlString += '</data>';

                const blob = new Blob([xmlString], { type: 'application/xml;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${new Date().toISOString().slice(0,10)}.xml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // 初始化語言
            setLanguage(currentLang);
        });
    </script>
</body>
</html>
